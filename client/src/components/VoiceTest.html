<!DOCTYPE html>
<html>
<head>
  <title>Voice Sommelier Test</title>
  <style>
    body { font-family: Arial; max-width: 800px; margin: 0 auto; padding: 20px; }
    .message { margin: 10px 0; padding: 10px; border-radius: 5px; }
    .user { background-color: #e6f7ff; text-align: right; }
    .assistant { background-color: #f9f9f9; }
    #mic-button { background: #8B0000; color: white; border: none; padding: 10px; border-radius: 50%; cursor: pointer; }
    #mic-button.listening { background: #ff0000; }
    #status { font-style: italic; margin: 10px 0; }
  </style>
</head>
<body>
  <h1>Voice Sommelier Test</h1>
  
  <div id="conversation">
    <div class="message assistant" data-role="assistant">
      Hi! I'm your personal wine sommelier. How can I help you today?
    </div>
  </div>
  
  <div id="status"></div>
  <div id="audio-controls" style="display: none; margin-top: 15px; text-align: center;">
    <button id="play-audio-btn" style="padding: 10px 20px; background-color: #8B0000; color: white; border: none; border-radius: 5px;">
      Play Response Audio
    </button>
  </div>
  
  <div style="margin-top: 20px;">
    <button id="mic-button">ðŸŽ¤</button>
    <button id="test-button" style="margin-left: 10px;">Test Audio</button>
    <button id="speak-last" style="margin-left: 10px;">Speak Last Response</button>
  </div>
  
  <script>
    // Immediate fix: Set up a global function to directly speak any text response
    window.speakDirectly = function(text) {
      console.log("DIRECT SPEAK REQUEST:", text.substring(0, 30) + "...");
      
      // Attempt OpenAI TTS first
      fetch('/api/text-to-speech', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ text })
      })
      .then(response => {
        if (!response.ok) throw new Error(`HTTP error: ${response.status}`);
        return response.blob();
      })
      .then(blob => {
        console.log("Audio received: Size =", blob.size, "bytes");
        
        // Create and directly play the audio
        const audio = new Audio();
        audio.src = URL.createObjectURL(blob);
        
        // Force audio to play with user interaction (needed for first play)
        const playPromise = audio.play();
        if (playPromise) {
          playPromise.catch(error => {
            console.error("Auto-play failed:", error);
            
            // Show a very visible play button if autoplay fails
            const playButton = document.createElement('button');
            playButton.textContent = 'â–¶ï¸ Play Voice Response';
            playButton.style.cssText = 'position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: #ff0000; color: white; font-size: 20px; padding: 20px; border: none; border-radius: 10px; box-shadow: 0 0 20px rgba(0,0,0,0.5); z-index: 9999; cursor: pointer;';
            
            playButton.onclick = function() {
              audio.play();
              document.body.removeChild(playButton);
            };
            
            document.body.appendChild(playButton);
          });
        }
      })
      .catch(error => {
        console.error("Error playing audio:", error);
        
        // Fallback to browser's speech synthesis
        if ('speechSynthesis' in window) {
          const utterance = new SpeechSynthesisUtterance(text);
          utterance.lang = 'en-US';
          window.speechSynthesis.speak(utterance);
        }
      });
    };
    
    // Simulated sendMessage for testing
    document.getElementById('test-button').addEventListener('click', function() {
      const testResponse = "For grilled salmon, I would recommend a Pinot Noir, which has light tannins and bright acidity that complement the rich flavor of the fish without overpowering it. Alternatively, a crisp Chardonnay with subtle oak notes can also pair beautifully, especially if your salmon has buttery or creamy sauce.";
      
      const assistantMessage = document.createElement('div');
      assistantMessage.className = 'message assistant';
      assistantMessage.setAttribute('data-role', 'assistant');
      assistantMessage.textContent = testResponse;
      document.getElementById('conversation').appendChild(assistantMessage);
      
      // Speak the response directly
      window.speakDirectly(testResponse);
    });
    
    document.getElementById('speak-last').addEventListener('click', function() {
      const conversation = document.getElementById('conversation');
      if (conversation) {
        const messages = conversation.querySelectorAll('.message.assistant');
        if (messages.length > 0) {
          const lastMessage = messages[messages.length - 1];
          window.speakDirectly(lastMessage.textContent);
        }
      }
    });
    
    // Set up microphone button
    const micButton = document.getElementById('mic-button');
    if (micButton) {
      micButton.addEventListener('click', function() {
        console.log("Microphone button clicked");
        
        // Create a user message
        const userText = "What wine pairs well with grilled salmon?";
        const userMessage = document.createElement('div');
        userMessage.className = 'message user';
        userMessage.textContent = userText;
        document.getElementById('conversation').appendChild(userMessage);
        
        // Simulate a response
        setTimeout(() => {
          const testResponse = "For grilled salmon, I would recommend a Pinot Noir, which has light tannins and bright acidity that complement the rich flavor of the fish without overpowering it. Alternatively, a crisp Chardonnay with subtle oak notes can also pair beautifully, especially if your salmon has buttery or creamy sauce.";
          
          const assistantMessage = document.createElement('div');
          assistantMessage.className = 'message assistant';
          assistantMessage.setAttribute('data-role', 'assistant');
          assistantMessage.textContent = testResponse;
          document.getElementById('conversation').appendChild(assistantMessage);
          
          // Speak the response directly
          window.speakDirectly(testResponse);
        }, 1000);
      });
    }
  </script>
</body>
</html>